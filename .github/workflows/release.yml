name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-release:
    name: Build Release (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: hotplugpp-linux-x64
          - os: windows-latest
            artifact_name: hotplugpp-windows-x64
          - os: macos-latest
            artifact_name: hotplugpp-macos-x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Run Tests
        working-directory: build
        run: ctest -C Release --output-on-failure --parallel

      - name: Package artifacts (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p package/include
          mkdir -p package/lib
          cp -r include/hotplugpp package/include/
          cp build/lib/*.a package/lib/ 2>/dev/null || true
          cp build/lib/*.so package/lib/ 2>/dev/null || true
          cp build/lib/*.dylib package/lib/ 2>/dev/null || true
          cp README.md LICENSE package/
          # Verify that at least one library file was packaged
          if [ ! "$(ls -A package/lib)" ]; then
            echo "Error: No library files found in build/lib"
            exit 1
          fi
          tar -czvf ${{ matrix.artifact_name }}.tar.gz -C package .

      - name: Package artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path package/include
          New-Item -ItemType Directory -Force -Path package/lib
          Copy-Item -Recurse include/hotplugpp package/include/
          Copy-Item build/lib/Release/*.lib package/lib/ -ErrorAction SilentlyContinue
          Copy-Item README.md, LICENSE package/
          # Verify that at least one library file was packaged
          if (-not (Get-ChildItem -Path package/lib -File)) {
            Write-Error "No library files found in build/lib/Release"
            exit 1
          }
          Compress-Archive -Path package/* -DestinationPath ${{ matrix.artifact_name }}.zip

      - name: Upload artifact (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}.tar.gz

      - name: Upload artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}.zip

  create-release:
    name: Create Release
    needs: build-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/*/*.tar.gz
            artifacts/*/*.zip
